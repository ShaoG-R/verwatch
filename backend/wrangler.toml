name = "verwatch"
main = "build/worker/shim.mjs"
compatibility_date = "2023-01-01"

# 显式开启 workers.dev 域名
workers_dev = true

# 显式开启预览功能
preview_urls = true

# Durable Object 绑定
[durable_objects]
bindings = [
    # ProjectRegistry: 管理所有 Monitor 的注册表 (单例)
    { name = "PROJECT_REGISTRY", class_name = "ProjectRegistry" },
    # ProjectMonitor: 每个项目的监控实例 (按 unique_key 分片)
    { name = "PROJECT_MONITOR", class_name = "ProjectMonitor" }
]

# 环境变量配置 (Vars)
[vars]
# Registry DO 绑定名称
REGISTRY_BINDING = "PROJECT_REGISTRY"
# Secret 变量名配置
ADMIN_SECRET_NAME = "ADMIN_SECRET"
GITHUB_TOKEN_NAME = "GITHUB_TOKEN"
PAT_TOKEN_NAME = "MY_GITHUB_PAT"

[[migrations]]
tag = "v2"
new_sqlite_classes = ["ProjectRegistry", "ProjectMonitor"]
deleted_classes = ["ProjectStore"]

[build]
command = "cargo install -q worker-build && worker-build --release"

[observability]
[observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true
persist = true